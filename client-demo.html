<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VB Language Server Demo</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #fff;
        }

        .header {
            margin-bottom: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            background: #252525;
        }

        .status.connected {
            background: #0e7a0d;
        }

        .status.error {
            background: #a1260d;
        }

        #editor {
            width: 100%;
            height: 600px;
            border: 1px solid #444;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Enhanced Visual Basic Language Server</h1>
        <div class="status" id="status">Connecting...</div>
    </div>
    <div id="editor"></div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>

    <script>
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            const statusEl = document.getElementById('status');

            // Register VB language
            monaco.languages.register({ id: 'vb' });

            // Configure the language service
            monaco.languages.registerCompletionItemProvider('vb', {
                triggerCharacters: ['.', ' '],
                provideCompletionItems: async (model, position) => {
                    console.log('Completion requested at position:', position);
                    const wordUntilPosition = model.getWordUntilPosition(position);
                    const lineUntilPosition = model.getLineContent(position.lineNumber).substring(0, position.column);

                    // Create LSP-style position
                    const lspPosition = {
                        line: position.lineNumber - 1,
                        character: position.column - 1
                    };

                    // Build workspace path
                    const workspaceRoot = window.location.pathname.startsWith('/')
                        ? window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))
                        : window.location.pathname.substring(1, window.location.pathname.lastIndexOf('/'));

                    const workspaceUri = 'file:///' + workspaceRoot.replace(/\\/g, '/');

                    // Create LSP-style text document
                    const textDocument = {
                        uri: workspaceUri + '/test/ComplexExample.vb',
                        languageId: 'vb',
                        version: model.getVersionId(),
                        text: model.getValue()
                    };

                    console.log('Document URI:', textDocument.uri);

                    // Wait for initialized before proceeding
                    if (!window.serverInitialized) {
                        console.log('Waiting for server initialization...');
                        return { suggestions: [] };
                    }

                    try {
                        // First, notify the server about the document
                        const didOpenNotification = {
                            jsonrpc: '2.0',
                            method: 'textDocument/didOpen',
                            params: {
                                textDocument: {
                                    uri: textDocument.uri,
                                    languageId: 'vb',
                                    version: 1,
                                    text: model.getValue()
                                }
                            }
                        };
                        console.log('Sending didOpen notification:', didOpenNotification);
                        window.ws.send(JSON.stringify(didOpenNotification));

                        // Send completion request to language server
                        const message = {
                            jsonrpc: '2.0',
                            id: Date.now(),
                            method: 'textDocument/completion',
                            params: {
                                textDocument: { uri: textDocument.uri },
                                position: lspPosition,
                                context: {
                                    triggerKind: 1,
                                    triggerCharacter: lineUntilPosition.endsWith('.') ? '.' : undefined
                                }
                            }
                        };
                        console.log('Sending completion request:', message);

                        if (window.ws.readyState === WebSocket.OPEN) {
                            return new Promise((resolve) => {
                                window.pendingRequest = {
                                    id: message.id,
                                    resolve: (result) => {
                                        const items = result || [];
                                        resolve({
                                            suggestions: items.map(item => ({
                                                label: item.label,
                                                kind: monaco.languages.CompletionItemKind[item.kind] || monaco.languages.CompletionItemKind.Text,
                                                detail: item.detail,
                                                documentation: item.documentation,
                                                insertText: item.insertText || item.label
                                            }))
                                        });
                                    }
                                };
                                window.ws.send(JSON.stringify(message));
                            });
                        }
                    } catch (error) {
                        console.error('Completion error:', error);
                    }

                    return { suggestions: [] };
                }
            });

            // Basic syntax highlighting
            monaco.languages.setMonarchTokensProvider('vb', {
                keywords: [
                    'Dim', 'Public', 'Private', 'Function', 'Sub', 'Class', 'Module',
                    'If', 'Then', 'Else', 'End', 'For', 'Next', 'While', 'Return', 'As', 'New'
                ],
                tokenizer: {
                    root: [
                        [/'.*$/, 'comment'],
                        [/".*?"/, 'string'],
                        [/\d+/, 'number'],
                        [/[a-z_$][\w$]*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@default': 'identifier'
                            }
                        }]
                    ]
                }
            });

            // Create editor
            const editor = monaco.editor.create(document.getElementById('editor'), {
                value: `' Advanced Visual Basic Example - Employee Management System
' Demonstrates: Inheritance, Properties, Collections, Error Handling

' Base class for Person
Public Class Person
    Private _firstName As String
    Private _lastName As String
    Private _age As Integer

    ' Properties with Get/Set
    Public Property FirstName As String
        Get
            Return _firstName
        End Get
        Set(value As String)
            If String.IsNullOrEmpty(value) Then
                Throw New ArgumentException("First name cannot be empty")
            End If
            _firstName = value
        End Set
    End Property

    Public Property LastName As String
        Get
            Return _lastName
        End Get
        Set(value As String)
            _lastName = value
        End Set
    End Property

    Public Property Age As Integer
        Get
            Return _age
        End Get
        Set(value As Integer)
            If value < 0 Or value > 150 Then
                Throw New ArgumentOutOfRangeException("Invalid age")
            End If
            _age = value
        End Set
    End Property

    ' Constructor
    Public Sub New(firstName As String, lastName As String, age As Integer)
        Me.FirstName = firstName
        Me.LastName = lastName
        Me.Age = age
    End Sub

    ' Virtual method for override
    Public Overridable Function GetFullInfo() As String
        Return String.Format("{0} {1}, Age: {2}", _firstName, _lastName, _age)
    End Function
End Class

' Derived class for Employee
Public Class Employee
    Inherits Person

    Private _employeeId As String
    Private _salary As Decimal
    Private _department As String

    Public Property EmployeeId As String
        Get
            Return _employeeId
        End Get
        Set(value As String)
            _employeeId = value
        End Set
    End Property

    Public Property Salary As Decimal
        Get
            Return _salary
        End Get
        Set(value As Decimal)
            If value < 0 Then
                Throw New ArgumentException("Salary cannot be negative")
            End If
            _salary = value
        End Set
    End Property

    Public Property Department As String
        Get
            Return _department
        End Get
        Set(value As String)
            _department = value
        End Set
    End Property

    Public Sub New(firstName As String, lastName As String, age As Integer, _
                   empId As String, salary As Decimal, dept As String)
        MyBase.New(firstName, lastName, age)
        Me.EmployeeId = empId
        Me.Salary = salary
        Me.Department = dept
    End Sub

    ' Override base method
    Public Overrides Function GetFullInfo() As String
        Return String.Format("{0} | ID: {1} | Dept: {2} | Salary: ${3:N2}", _
                           MyBase.GetFullInfo(), _employeeId, _department, _salary)
    End Function

    ' Calculate annual bonus based on salary
    Public Function CalculateBonus(bonusPercentage As Double) As Decimal
        If bonusPercentage < 0 Or bonusPercentage > 100 Then
            Return 0
        End If
        Return _salary * (bonusPercentage / 100)
    End Function
End Class

' Manager class for employee operations
Public Class EmployeeManager
    Private employees As New List(Of Employee)

    ' Add employee to collection
    Public Sub AddEmployee(emp As Employee)
        If emp Is Nothing Then
            Throw New ArgumentNullException("Employee cannot be null")
        End If
        employees.Add(emp)
    End Sub

    ' Find employee by ID
    Public Function FindEmployeeById(empId As String) As Employee
        For Each emp As Employee In employees
            If emp.EmployeeId = empId Then
                Return emp
            End If
        Next
        Return Nothing
    End Function

    ' Get employees by department
    Public Function GetEmployeesByDepartment(dept As String) As List(Of Employee)
        Dim result As New List(Of Employee)
        For Each emp As Employee In employees
            If emp.Department.ToLower() = dept.ToLower() Then
                result.Add(emp)
            End If
        Next
        Return result
    End Function

    ' Calculate total payroll
    Public Function CalculateTotalPayroll() As Decimal
        Dim total As Decimal = 0
        For Each emp As Employee In employees
            total += emp.Salary
        Next
        Return total
    End Function

    ' Get average salary
    Public Function GetAverageSalary() As Decimal
        If employees.Count = 0 Then
            Return 0
        End If
        Return CalculateTotalPayroll() / employees.Count
    End Function

    ' Generate report
    Public Function GenerateReport() As String
        Dim report As String = "Employee Report" & vbCrLf
        report &= "===============" & vbCrLf & vbCrLf

        Dim count As Integer = 0
        For Each emp As Employee In employees
            count += 1
            report &= String.Format("{0}. {1}", count, emp.GetFullInfo()) & vbCrLf
        Next

        report &= vbCrLf & String.Format("Total Employees: {0}", employees.Count) & vbCrLf
        report &= String.Format("Total Payroll: ${0:N2}", CalculateTotalPayroll()) & vbCrLf
        report &= String.Format("Average Salary: ${0:N2}", GetAverageSalary())

        Return report
    End Function
End Class

' Try the LSP features:
' - Press Ctrl+Space after typing "Dim emp As " to see type suggestions
' - Type "emp." to see available methods and properties
' - Hover over any keyword or identifier for information`,
                language: 'vb',
                theme: 'vs-dark',
                automaticLayout: true
            });

            // Try to connect to language server
            try {
                window.ws = new WebSocket('ws://localhost:3001');

                window.serverInitialized = false;
                window.ws.onopen = () => {
                    statusEl.textContent = 'Connected, initializing...';
                    statusEl.className = 'status';
                    console.log('WebSocket connected, sending initialize request...');
                };

                window.ws.onmessage = (event) => {
                    console.log('Received from server:', event.data);
                    try {
                        const response = JSON.parse(event.data);
                        console.log('Parsed response:', response);

                        // Handle initialization sequence
                        if (response.id === 0) {
                            console.log('Received initialize response, sending initialized notification');
                            window.ws.send(JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'initialized',
                                params: {}
                            }));

                            // Configure the workspace
                            const configureRequest = {
                                jsonrpc: '2.0',
                                id: 1,
                                method: 'workspace/didChangeConfiguration',
                                params: {
                                    settings: {
                                        visualBasic: {
                                            indexing: {
                                                enabled: true,
                                                includeFiles: ["**/*.vb"]
                                            }
                                        }
                                    }
                                }
                            };
                            window.ws.send(JSON.stringify(configureRequest));

                            window.serverInitialized = true;
                            statusEl.textContent = '✓ Server initialized - Try Ctrl+Space for completions';
                            statusEl.className = 'status connected';
                        }

                        // Handle workspace configuration response
                        if (response.id === 1) {
                            console.log('Workspace configured');
                        }

                        // Handle server messages
                        if (response.method === 'window/logMessage' || response.method === 'window/showMessage') {
                            console.log('Server message:', response.params.message);
                        }

                        // Handle completion responses
                        if (window.pendingRequest && response.id === window.pendingRequest.id) {
                            console.log('Received completion response:', response.result);
                            window.pendingRequest.resolve(response.result);
                            window.pendingRequest = null;
                        }
                    } catch (e) {
                        console.warn('Failed to parse server message:', e);
                        console.log('Raw message:', event.data);
                    }
                };

                // Build workspace path and initialize request
                const workspaceRoot = window.location.pathname.startsWith('/')
                    ? window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))
                    : window.location.pathname.substring(1, window.location.pathname.lastIndexOf('/'));

                const workspaceUri = 'file:///' + workspaceRoot.replace(/\\/g, '/');
                console.log('Workspace URI:', workspaceUri);

                // Send initialize request with debug logging
                setTimeout(() => {
                    const initializeRequest = {
                        jsonrpc: '2.0',
                        id: 0,
                        method: 'initialize',
                        params: {
                            processId: null,
                            rootUri: workspaceUri,
                            capabilities: {
                                workspace: {
                                    workspaceFolders: true,
                                    configuration: true,
                                    didChangeConfiguration: { dynamicRegistration: true }
                                },
                                textDocument: {
                                    completion: {
                                        dynamicRegistration: true,
                                        contextSupport: true,
                                        completionItem: {
                                            snippetSupport: true,
                                            documentationFormat: ['markdown', 'plaintext'],
                                            deprecatedSupport: true,
                                            preselectSupport: true,
                                            insertReplaceSupport: true
                                        },
                                        completionItemKind: { valueSet: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25] }
                                    },
                                    synchronization: {
                                        dynamicRegistration: true,
                                        willSave: true,
                                        willSaveWaitUntil: true,
                                        didSave: true
                                    }
                                }
                            },
                            workspaceFolders: [{
                                uri: workspaceUri,
                                name: 'VB Workspace'
                            }]
                        }
                    };
                    console.log('Sending initialize request:', initializeRequest);
                    window.ws.send(JSON.stringify(initializeRequest));
                }, 100);

                window.ws.onerror = (error) => {
                    statusEl.textContent = '✗ Not connected (server not running on port 3001)';
                    statusEl.className = 'status error';
                    console.error('WebSocket error:', error);
                };

                window.ws.onclose = () => {
                    statusEl.textContent = '✗ Disconnected';
                    statusEl.className = 'status error';
                };
            } catch (error) {
                statusEl.textContent = '✗ Connection failed';
                statusEl.className = 'status error';
                console.error('Connection error:', error);
            }

            console.log('%cLanguage Server Demo', 'font-size: 16px; font-weight: bold');
            console.log('Start server: npm run start:bridge');
            console.log('Shortcuts:');
            console.log('  Ctrl+Space: Code completion');
            console.log('  F12: Go to definition');
        });
    </script>
</body>

</html>
